<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="budget">

    <!-- 데이터 존재 연도 조회 -->
    <select id="selectDistinctYears"
            resultType="int">
        SELECT DISTINCT year
        FROM budget_monthly
        ORDER BY year ASC
    </select>

    <!-- 연도별 예산 조회 -->
    <select id="selectBudgetByYear"
            parameterType="int"
            resultType="com.mcmp.costbe.budget.model.BudgetItemModel">
        SELECT csp, year, month, budget, currency
        FROM budget_monthly
        WHERE year = #{year}
        ORDER BY csp, month
    </select>

    <!-- 예산 upsert -->
    <insert id="upsertBudget"
            parameterType="com.mcmp.costbe.budget.model.BudgetItemModel">
        INSERT INTO budget_monthly (csp, year, month, budget, currency)
        VALUES (#{csp}, #{year}, #{month}, #{budget}, #{currency})
            ON DUPLICATE KEY UPDATE
                                 budget = VALUES(budget),
                                 currency = VALUES(currency),
                                 updated_at = CURRENT_TIMESTAMP
    </insert>

    <!-- 실제 사용량 (연도별) -->
    <select id="selectActualUsageByYear"
            parameterType="int"
            resultType="com.mcmp.costbe.budget.model.ActualUsageItemModel">
        <![CDATA[
        SELECT
            ms.year_month COLLATE utf8mb4_unicode_ci AS yearMonth,
            'AWS' COLLATE utf8mb4_unicode_ci AS csp,
            COALESCE(SUM(ms.total_cost), 0) AS bill
        FROM monthly_summation ms
        WHERE ms.year_month >= CONCAT(#{year}, '01')
          AND ms.year_month <= CONCAT(#{year}, '12')
        GROUP BY ms.year_month

        UNION ALL

        SELECT
            vm_latest.demand_month COLLATE utf8mb4_unicode_ci AS yearMonth,
            'NCP' COLLATE utf8mb4_unicode_ci AS csp,
            COALESCE(SUM(vm_latest.demand_amount), 0) / 1400.0 AS bill
        FROM (
            SELECT n1.demand_month, n1.demand_amount
            FROM ncp_cost_service_month n1
            INNER JOIN (
                SELECT product_demand_type, demand_month, MAX(write_date) AS latest_write_date
                FROM ncp_cost_service_month
                WHERE demand_month >= CONCAT(#{year}, '01')
                  AND demand_month <= CONCAT(#{year}, '12')
                GROUP BY product_demand_type, demand_month
            ) n2
            ON n1.product_demand_type = n2.product_demand_type
            AND n1.demand_month = n2.demand_month
            AND n1.write_date = n2.latest_write_date
        ) vm_latest
        GROUP BY vm_latest.demand_month

        UNION ALL

        SELECT
            DATE_FORMAT(STR_TO_DATE(a.usage_date, '%Y%m%d'), '%Y%m') COLLATE utf8mb4_unicode_ci AS yearMonth,
            'Azure' COLLATE utf8mb4_unicode_ci AS csp,
            COALESCE(SUM(a.pre_tax_cost), 0) / 1400.0 AS bill
        FROM azure_cost_service_daily a
        WHERE a.usage_date >= CONCAT(#{year}, '0101')
          AND a.usage_date <= CONCAT(#{year}, '1231')
        GROUP BY DATE_FORMAT(STR_TO_DATE(a.usage_date, '%Y%m%d'), '%Y%m')

        ORDER BY yearMonth ASC, csp ASC
        ]]>
    </select>

</mapper>
